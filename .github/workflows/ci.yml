name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop, 'feature/**']

env:
  DBT_PROFILES_DIR: ./dbt
  PYTHON_VERSION: '3.9'

jobs:
  # Job 1: SQL Linting
  lint-sql:
    name: Lint SQL Files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install SQLFluff
        run: |
          pip install sqlfluff sqlfluff-templater-dbt

      - name: Lint SQL files
        run: |
          cd dbt
          sqlfluff lint models/ --dialect tsql || true
        continue-on-error: true

      - name: Annotate SQL linting results
        if: always()
        run: |
          echo "::notice::SQL linting completed (warnings allowed)"

  # Job 2: Python Linting
  lint-python:
    name: Lint Python Files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install flake8 black

      - name: Run Black formatter check
        run: |
          black --check --line-length=120 airflow/dags/ || true
        continue-on-error: true

      - name: Run Flake8
        run: |
          flake8 airflow/dags/ --max-line-length=120 --count --statistics --ignore=E203,W503 || true
        continue-on-error: true

      - name: Annotate Python linting results
        if: always()
        run: |
          echo "::notice::Python linting completed (warnings allowed)"

  # Job 3: DBT Compilation Check
  dbt-compile:
    name: Compile DBT Models
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-sql, lint-python]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 unixodbc-dev

      - name: Install DBT SQLServer adapter
        run: |
          pip install dbt-sqlserver

      - name: Create DBT profiles.yml
        run: |
          mkdir -p dbt
          cat > dbt/profiles.yml << EOF
          dbt_airflow_project:
            target: ${{ secrets.DBT_TARGET }}
            outputs:
              ${{ secrets.DBT_TARGET }}:
                type: sqlserver
                driver: 'ODBC Driver 17 for SQL Server'
                server: ${{ secrets.DBT_SERVER }}
                port: ${{ secrets.DBT_PORT }}
                database: ${{ secrets.DBT_DATABASE }}
                schema: ${{ secrets.DBT_SCHEMA }}
                user: ${{ secrets.DBT_USER }}
                password: ${{ secrets.DBT_PASSWORD }}
                trust_cert: true  # <--- THÊM DÒNG NÀY
                encrypt: true     # (Tùy chọn) Thường đi kèm với trust_cert
          EOF
  
      - name: Install DBT dependencies
        run: |
          cd dbt
          dbt deps --profiles-dir .

      - name: Compile DBT models
        id: compile
        run: |
          cd dbt
          dbt compile --profiles-dir . || exit 1

      - name: Upload compiled artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-compiled
          path: dbt/target/
          retention-days: 7

      - name: Annotate compilation results
        if: failure()
        run: |
          echo "::error::DBT model compilation failed"
          exit 1

  # Job 4: PR Validation
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for large files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | while read file; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file" 2>/dev/null || echo 0)
              if [ $size -gt 1000000 ]; then
                echo "::error::File $file is larger than 1MB (size: $size bytes)"
                exit 1
              fi
            fi
          done
          echo " No large files detected"

      - name: Check for merge conflicts
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs grep -l "<<<<<<< HEAD" 2>/dev/null; then
            echo "::error::Merge conflicts detected in changed files"
            exit 1
          fi
          echo " No merge conflicts detected"

      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          CHANGED_LINES=$(git diff origin/${{ github.base_ref }}...HEAD | wc -l || echo 0)
          
          echo "Files changed: $CHANGED_FILES"
          echo "Lines changed: $CHANGED_LINES"
          
          if [ $CHANGED_FILES -gt 50 ]; then
            echo "::warning::This PR changes more than 50 files. Consider splitting it."
          fi
          
          if [ $CHANGED_LINES -gt 1000 ]; then
            echo "::warning::This PR changes more than 1000 lines. Consider splitting it."
          fi

      - name: Validate DBT models changed
        run: |
          echo "DBT models changed in this PR:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "dbt/models/" || echo "No DBT models changed"

  # Job 5: Generate DBT Documentation
  generate-docs:
    name: Generate DBT Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: dbt-compile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 unixodbc-dev

      - name: Install DBT SQLServer adapter
        run: |
          pip install dbt-sqlserver

      - name: Create DBT profiles.yml
        run: |
          mkdir -p dbt
          cat > dbt/profiles.yml << EOF
          dbt_airflow_project:
            target: ${{ secrets.DBT_TARGET }}
            outputs:
              ${{ secrets.DBT_TARGET }}:
                type: sqlserver
                driver: 'ODBC Driver 17 for SQL Server'
                server: ${{ secrets.DBT_SERVER }}
                port: ${{ secrets.DBT_PORT }}
                database: ${{ secrets.DBT_DATABASE }}
                schema: ${{ secrets.DBT_SCHEMA }}
                user: ${{ secrets.DBT_USER }}
                password: ${{ secrets.DBT_PASSWORD }}
                trust_cert: true  # <--- THÊM DÒNG NÀY
                encrypt: true     # (Tùy chọn) Thường đi kèm với trust_cert
          EOF

      - name: Download compiled artifacts
        uses: actions/download-artifact@v4
        with:
          name: dbt-compiled
          path: dbt/target/

      - name: Install DBT dependencies
        run: |
          cd dbt
          dbt deps --profiles-dir .

      - name: Compile DBT models (for docs)
        run: |
          cd dbt
          dbt compile --profiles-dir . || true

      - name: Generate DBT documentation
        run: |
          cd dbt
          dbt docs generate --profiles-dir . || true

      - name: Upload documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            dbt/target/catalog.json
            dbt/target/manifest.json
            dbt/target/index.html
          retention-days: 30

      - name: Annotate documentation generation
        if: always()
        run: |
          echo "::notice::DBT documentation generated"

  # Job 6: CI Summary
  ci-summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint-sql, lint-python, dbt-compile, pr-validation, generate-docs]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create CI summary
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Linting | ${{ needs.lint-sql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Linting | ${{ needs.lint-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DBT Compilation | ${{ needs.dbt-compile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Validation | ${{ needs.pr-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.generate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.dbt-compile.result }}" != "success" ]; then
            echo "**CI Pipeline Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo " **CI Pipeline Passed**" >> $GITHUB_STEP_SUMMARY
          fi

